name: ClashForge

on:
  push:
    paths-ignore:
      - '**'
  workflow_dispatch:

jobs:
  run_demo_actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT }}

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10.10'

      - name: Install requirements.txt
        run: |
          pip install -r ./requirements.txt

      - name: Run ClashForge.py
        run: python ClashForge.py

      - name: Push to Existing Gist
        env:
          GIST_ID: cc41c0b0b0d3f55ea11b576b0b5ba200
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILE_PATH="clash_config.yaml"
          NEW_FILE_NAME="clashforge.yaml"

          # Get the Gist details
          GIST_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/gists/$GIST_ID")

          # Prepare the updated file content
          CONTENT=$(cat "$FILE_PATH")

          # Update the gist with the new file content and the new filename
          curl -X PATCH -H "Authorization: token $GITHUB_TOKEN" \
            -d '{"files": {"'$NEW_FILE_NAME'": {"content": "'"$CONTENT"'"}}}' \
            "https://api.github.com/gists/$GIST_ID"
